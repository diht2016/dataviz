<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph Relaxation</title>
    <link rel="stylesheet" href="./css/main.css">
    <link rel="shortcut icon" href="./images/favicon.png">
</head>
<body>
    <div id="overlay">
        <span id="curr-graph-desc"></span>
        <br>
        Click or press Enter to randomize
        <br>
        <input type="checkbox" id="input-toggler">
        <label class="collapser" for="input-toggler">Edit functions</label>
        <div id="func-inputs" class="collapsible"></div>
    </div>
    <script src="./js/graph.js"></script>
    <script src="./js/svg-graph.js"></script>
    <script src="./js/func-input.js"></script>
    <script>

        let sqrt = Math.sqrt
        let min = Math.min
        let max = Math.max

        let graph2d = null
        let dist2d = xy => sqrt(xy[0] ** 2 + xy[1] ** 2)
        let diff2d = (xy1, xy2) => [xy1[0] - xy2[0], xy1[1] - xy2[1]]

        function initRandom() {
            graph2d = scatteredCircle(pickRandomGraph())
            setGraph(graph2d)
        }

        createFuncInput("fConnected", "d => 0.01 * d", "Connected attraction force")
        createFuncInput("fCrowd", "d => -1 / (0.01 + d**2)", "Eachother attraction force")
        createFuncInput("fCenter", "(d, n) => 0.01 * d**2", "Center attraction force")
        createFuncInput("fPower", "k => min(1, 40/k**2)", "Connections multiplier")
        //createFuncInput("fCount", "n => 1", "Center multiplier")
        createFuncInput("fNorm", "d => min(d**0.25, d * 5)", "Speed correction")
        createFuncInput("fScale", "n => sqrt(n) * 5", "Distance scale")

        function relax() {
            let scale = fScale(graph2d.n)
            let newCoords = Array()
            graph2d.iterVertices(a => {
                let axy = graph2d.coords[a]
                let diffCoords = graph2d.coords.map(xy => diff2d(xy, axy))
                let dists = diffCoords.map(xy => dist2d(xy) * scale)
                let nxy = [0, 0]
                let add = (xy, k) => {
                    nxy[0] += xy[0] * k
                    nxy[1] += xy[1] * k
                }
                let centerDiff = axy.map(t => 1 - t * 2)
                let centerDist = dist2d(centerDiff)
                //let kCenter = fCount(graph2d.n)
                add(centerDiff, fCenter(centerDist) / centerDist)
                let kConnects = fPower(graph2d.powers[a])
                diffCoords.forEach((xy, i) => {
                    let d = dists[i]
                    if (!d) return
                    add(xy, fCrowd(d) / d)
                    if (!graph2d.table[a][i]) return
                    add(xy, kConnects * fConnected(d) / d)
                })
                let deltaNorm = dist2d(nxy)
                nxy = nxy.map(t => t * fNorm(deltaNorm * scale) / deltaNorm / scale)
                add(axy, 1)
                newCoords.push(nxy)
            })
            graph2d.coords = newCoords
        }

        function update() {
            relax()
            setGraph(graph2d)
        }

        initRandom()
        let listener = (e) => {
            initRandom()
            e.preventDefault()
            e.stopPropagation()
        }
        window.onkeydown = (e) => {
            if (e.code == 'Enter') listener(e)
            //console.log(e)
        }
        svg.onmousedown = listener

        setInterval(update, 20)

    </script>
</body>
</html>